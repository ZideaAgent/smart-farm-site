<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartFarm - Crop Prediction</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                <div class="logo">
                    <i class="fas fa-leaf"></i>
                    <span>SmartFarm</span>
                </div>
            </a>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="dashboard.html">Dashboard</a>
                <a href="pump.html">Pump</a>
                <div class="dropdown">
                    <a href="#" class="dropdown-trigger">Predict</a>
                    <div class="dropdown-content">
                        <a href="crop-prediction.html" class="active">Crop</a>
                        <a href="fertilizer-prediction.html">Fertilizer</a>
                        <a href="yield-prediction.html">Yield</a>
                    </div>
                </div>
                <a href="disease-detection.html">Disease</a>
                <a href="chatbot.html">Chat</a>
                <a href="about.html">About</a>
            </div>
            <div class="auth-controls">
                <span id="greeting">Hello, Ziad</span>
                <button id="logoutBtn" class="btn-logout">Logout</button>
            </div>
        </div>
    </nav>

    <div class="hero-section">
        <div class="hero-content">
            <h1>Crop Prediction</h1>
            <p>Leverage AI to predict the best crops for your farm based on soil conditions, climate data, and historical patterns.</p>
            <div class="hero-buttons">
                <a href="#prediction-form" class="btn btn-primary">Get Prediction</a>
                <a href="dashboard.html" class="btn btn-outline">View Dashboard</a>
            </div>
        </div>
        <div class="hero-image">
            <img src="https://images.unsplash.com/photo-1625246333195-78d9c38ad449?ixlib=rb-4.0.3" alt="Crop Prediction">
        </div>
    </div>

    <div id="prediction-form" class="main-content">
        <div class="container mx-auto px-4 py-8">
            <div class="max-w-4xl mx-auto">
                <h1 class="text-3xl font-bold text-gray-800 mb-8 flex items-center">
                    <i class="fas fa-seedling text-green-500 mr-3"></i>
                    Crop Recommendation System
                </h1>

                <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                    <form id="cropPredictionForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Nitrogen -->
                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Nitrogen (N)
                                    <i class="fas fa-info-circle text-gray-400 ml-1" title="Nitrogen content in soil (0-140)"></i>
                                </label>
                                <input type="number" id="nitrogen" name="nitrogen" min="0" max="140" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>

                            <!-- Phosphorus -->
                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Phosphorus (P)
                                    <i class="fas fa-info-circle text-gray-400 ml-1" title="Phosphorus content in soil (5-145)"></i>
                                </label>
                                <input type="number" id="phosphorus" name="phosphorus" min="5" max="145" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>

                            <!-- Potassium -->
                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Potassium (K)
                                    <i class="fas fa-info-circle text-gray-400 ml-1" title="Potassium content in soil (5-205)"></i>
                                </label>
                                <input type="number" id="potassium" name="potassium" min="5" max="205" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>

                            <!-- Temperature -->
                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Temperature (°C)
                                    <i class="fas fa-info-circle text-gray-400 ml-1" title="Temperature in Celsius (8-44)"></i>
                                </label>
                                <input type="number" id="temperature" name="temperature" min="8" max="44" step="0.1" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>

                            <!-- pH -->
                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    pH Level
                                    <i class="fas fa-info-circle text-gray-400 ml-1" title="Soil pH level (3.5-10)"></i>
                                </label>
                                <input type="number" id="ph" name="ph" min="3.5" max="10" step="0.1" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>

                            <!-- Rainfall -->
                            <div class="form-group">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Rainfall (mm)
                                    <i class="fas fa-info-circle text-gray-400 ml-1" title="Annual rainfall in mm (20-300)"></i>
                                </label>
                                <input type="number" id="rainfall" name="rainfall" min="20" max="300" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>

                        <div class="flex justify-center space-x-4">
                            <button type="submit" class="btn btn-primary flex items-center">
                                <i class="fas fa-magic mr-2"></i>
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-8 flex items-center">
                <i class="fas fa-seedling text-green-500 mr-3"></i>
                Crop Recommendation System
            </h1>

            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <form id="cropPredictionForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Nitrogen -->
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Nitrogen (N)
                                <i class="fas fa-info-circle text-gray-400 ml-1" title="Nitrogen content in soil (0-140)"></i>
                            </label>
                            <input type="number" id="nitrogen" name="nitrogen" min="0" max="140" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <!-- Phosphorus -->
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Phosphorus (P)
                                <i class="fas fa-info-circle text-gray-400 ml-1" title="Phosphorus content in soil (5-145)"></i>
                            </label>
                            <input type="number" id="phosphorus" name="phosphorus" min="5" max="145" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <!-- Potassium -->
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Potassium (K)
                                <i class="fas fa-info-circle text-gray-400 ml-1" title="Potassium content in soil (5-205)"></i>
                            </label>
                            <input type="number" id="potassium" name="potassium" min="5" max="205" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <!-- Temperature -->
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Temperature (°C)
                                <i class="fas fa-info-circle text-gray-400 ml-1" title="Temperature in Celsius (8-44)"></i>
                            </label>
                            <input type="number" id="temperature" name="temperature" min="8" max="44" step="0.1" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <!-- pH -->
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                pH Level
                                <i class="fas fa-info-circle text-gray-400 ml-1" title="Soil pH level (3.5-10)"></i>
                            </label>
                            <input type="number" id="ph" name="ph" min="3.5" max="10" step="0.1" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <!-- Rainfall -->
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Rainfall (mm)
                                <i class="fas fa-info-circle text-gray-400 ml-1" title="Annual rainfall in mm (20-300)"></i>
                            </label>
                            <input type="number" id="rainfall" name="rainfall" min="20" max="300" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>

                    <div class="flex justify-center space-x-4">
                        <button type="submit" class="btn btn-primary flex items-center">
                            <i class="fas fa-magic mr-2"></i>
                            Get Crop Recommendations
                        </button>
                        <button type="button" id="fetchFirebaseDataBtn" class="btn btn-outline flex items-center">
                            <i class="fas fa-cloud-download-alt mr-2"></i>
                            Fetch Sensor Data
                        </button>
                    </div>
                </form>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="hidden">
                <div class="flex justify-center items-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500"></div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Recommended Crops</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="cropResults">
                    <!-- Results will be dynamically inserted here -->
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mt-4" role="alert">
                <span class="block sm:inline"></span>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

        // Your web app's Firebase configuration (copy from dashboard.html or pump.html)
        const firebaseConfig = {
            apiKey: "AIzaSyDL2h9dxXjU-2a6lEwK-iR2AL76FHLGc88", // Use YOUR_API_KEY placeholder
            authDomain: "smartfarm-50e9f.firebaseapp.com", // Use YOUR_AUTH_DOMAIN placeholder
            databaseURL: "https://smartfarm-50e9f-default-rtdb.firebaseio.com",
            projectId: "smartfarm-50e9f", // Use YOUR_PROJECT_ID placeholder
            storageBucket: "smartfarm-50e9f.firebasestorage.app", // Use YOUR_STORAGE_BUCKET placeholder
            messagingSenderId: "615423373084", // Use YOUR_MESSAGING_SENDER_ID placeholder
            appId: "1:615423373084:web:e4af0444a7db2f9fa754d9", // Use YOUR_APP_ID placeholder
            measurementId: "G-8TDXE1451F"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // User is not signed in, redirect to login page
                window.location.href = 'login.html';
            }
        });

        document.getElementById('cropPredictionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Show loading spinner
            document.getElementById('loadingSpinner').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');

            // Get form data
            const formData = {
                N: parseFloat(document.getElementById('nitrogen').value),
                P: parseFloat(document.getElementById('phosphorus').value),
                K: parseFloat(document.getElementById('potassium').value),
                temperature: parseFloat(document.getElementById('temperature').value),
                ph: parseFloat(document.getElementById('ph').value),
                rainfall: parseFloat(document.getElementById('rainfall').value)
            };

            try {
                const data = await getCropPrediction(formData);
                
                // Display results
                const resultsContainer = document.getElementById('cropResults');
                resultsContainer.innerHTML = '';

                data.forEach((crop, index) => {
                    const probability = (crop.probability * 100).toFixed(1);
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow-md p-6 transform transition-transform hover:scale-105';
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold text-gray-800">${crop.crop}</h3>
                            <span class="text-2xl font-bold text-green-500">${probability}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-green-500 h-2.5 rounded-full" style="width: ${probability}%"></div>
                        </div>
                        <button class="btn btn-secondary mt-4 w-full select-crop-btn" data-crop-name="${crop.crop}">
                            Select This Crop
                        </button>
                    `;
                    resultsContainer.appendChild(card);
                });

                // Add event listeners to newly created buttons
                document.querySelectorAll('.select-crop-btn').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const cropName = event.target.dataset.cropName;
                        if (confirm(`Are you sure you want to select ${cropName} as the current crop?`)) {
                            try {
                                const controlPlantRef = ref(database, 'control/plant');
                                await set(controlPlantRef, cropName);
                                alert(`${cropName} has been successfully selected as the current crop in Firebase!`);
                            } catch (error) {
                                document.getElementById('errorMessage').classList.remove('hidden');
                                document.getElementById('errorMessage').querySelector('span').textContent = 
                                    `Failed to save crop to Firebase: ${error.message}`;
                            }
                        }
                    });
                });

                document.getElementById('resultsSection').classList.remove('hidden');
            } catch (error) {
                document.getElementById('errorMessage').classList.remove('hidden');
                let errorMessageText = 'Failed to get crop predictions. Please try again.';
                if (error.response && error.response.json) {
                    try {
                        const errorData = await error.response.json();
                        if (errorData.detail) {
                            errorMessageText = `API Error: ${errorData.detail}`;
                        } else if (errorData.message) {
                            errorMessageText = `API Error: ${errorData.message}`;
                        } else {
                            errorMessageText = `API Error: ${JSON.stringify(errorData)}`;
                        }
                    } catch (jsonError) {
                        errorMessageText = `Network Error: ${error.message}`;
                    }
                } else {
                    errorMessageText = `Network Error: ${error.message}`;
                }
                document.getElementById('errorMessage').querySelector('span').textContent = errorMessageText;
            } finally {
                document.getElementById('loadingSpinner').classList.add('hidden');
            }
        });

        const fetchFirebaseDataBtn = document.getElementById('fetchFirebaseDataBtn');
        fetchFirebaseDataBtn.addEventListener('click', async () => {
            try {
                // Show loading spinner
                document.getElementById('loadingSpinner').classList.remove('hidden');
                document.getElementById('errorMessage').classList.add('hidden');

                const sensorRef = ref(database, 'sensor');
                const snapshot = await get(sensorRef);

                if (snapshot.exists()) {
                    const data = snapshot.val();
                    document.getElementById('temperature').value = data.temp !== undefined ? data.temp : '';
                    document.getElementById('rainfall').value = data.rain !== undefined ? data.rain : '';
                    // N, P, K, pH are not directly available from typical environmental sensors.
                    // User will still need to input these manually.
                    alert('Temperature and Rainfall data fetched from Firebase. Please manually enter Nitrogen, Phosphorus, Potassium, and pH values.');
                } else {
                    alert('No sensor data available in Firebase to fetch.');
                }
            } catch (error) {
                document.getElementById('errorMessage').classList.remove('hidden');
                document.getElementById('errorMessage').querySelector('span').textContent = 
                    `Failed to fetch sensor data from Firebase: ${error.message}`;
            } finally {
                document.getElementById('loadingSpinner').classList.add('hidden');
            }
        });

        async function getCropPrediction(formData) {
            try {
                const response = await fetch('https://zidea21-crop-prediction.hf.space/predict_crop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to get crop predictions');
                }

                const data = await response.json();
                return data.predictions;
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }
    </script>
</body>
</html> 