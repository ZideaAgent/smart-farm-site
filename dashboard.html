<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartFarm - Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                <div class="logo">
                    <i class="fas fa-leaf"></i>
                    <span>SmartFarm</span>
                </div>
            </a>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="dashboard.html" class="active">Dashboard</a>
                <a href="pump.html">Pump</a>
                <div class="dropdown">
                    <a href="#" class="dropdown-trigger">Predict</a>
                    <div class="dropdown-content">
                        <a href="crop-prediction.html">Crop</a>
                        <a href="fertilizer-prediction.html">Fertilizer</a>
                        <a href="yield-prediction.html">Yield</a>
                    </div>
                </div>
                <a href="disease-detection.html">Disease</a>
                <a href="chatbot.html">Chat</a>
                <a href="about.html">About</a>
            </div>
            <div class="auth-controls">
                <span id="greeting">Hello, Ziad</span>
                <button id="logoutBtn" class="btn-logout">Logout</button>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <h1>Farm Dashboard</h1>
        <div class="card-grid">
            <div class="card">
                <div class="card-icon">
                    <i class="fas fa-temperature-high" id="tempIcon"></i>
                </div>
                <div class="sensor-label">Temperature</div>
                <div class="sensor-value" id="temperature">--°C</div>
            </div>
            <div class="card">
                <div class="card-icon">
                    <i class="fas fa-droplet" id="humidityIcon"></i>
                </div>
                <div class="sensor-label">Humidity</div>
                <div class="sensor-value" id="humidity">--%</div>
            </div>
            <div class="card">
                <div class="card-icon">
                    <i class="fas fa-seedling" id="soilIcon"></i>
                </div>
                <div class="sensor-label">Soil Moisture</div>
                <div class="sensor-value" id="soilMoisture">--%</div>
            </div>
            <div class="card">
                <div class="card-icon">
                    <i class="fas fa-cloud-rain" id="rainIcon"></i>
                </div>
                <div class="sensor-label">Rain Level</div>
                <div class="sensor-value" id="rainLevel">--mm</div>
            </div>
            <div class="card" id="waterLevelCard">
                <div class="card-icon">
                    <i class="fas fa-water" id="waterIcon"></i>
                </div>
                <div class="sensor-label">Water Level</div>
                <div class="sensor-value" id="waterLevel">--%</div>
            </div>
            <div class="card">
                <div class="card-icon">
                    <i class="fas fa-flask" id="nitrogenIcon"></i>
                </div>
                <div class="sensor-label">Nitrogen</div>
                <div class="sensor-value" id="nitrogen">--mg/kg</div>
            </div>
            <div class="card">
                <div class="card-icon">
                    <i class="fas fa-flask" id="phosphorusIcon"></i>
                </div>
                <div class="sensor-label">Phosphorus</div>
                <div class="sensor-value" id="phosphorus">--mg/kg</div>
            </div>
            <div class="card">
                <div class="card-icon">
                    <i class="fas fa-flask" id="potassiumIcon"></i>
                </div>
                <div class="sensor-label">Potassium</div>
                <div class="sensor-value" id="potassium">--mg/kg</div>
            </div>
        </div>

        <div class="charts-section">
            <h2>Sensor Data History</h2>
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>Temperature History</h3>
                    <div id="temperatureChart"></div>
                </div>
                <div class="chart-card">
                    <h3>Humidity History</h3>
                    <div id="humidityChart"></div>
                </div>
                <div class="chart-card">
                    <h3>Soil Moisture History</h3>
                    <div id="soilChart"></div>
                </div>
                <div class="chart-card">
                    <h3>Nitrogen History</h3>
                    <div id="nitrogenChart"></div>
                </div>
                <div class="chart-card">
                    <h3>Phosphorus History</h3>
                    <div id="phosphorusChart"></div>
                </div>
                <div class="chart-card">
                    <h3>Potassium History</h3>
                    <div id="potassiumChart"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-analytics.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDL2h9dxXjU-2a6lEwK-iR2AL76FHLGc88", // Use YOUR_API_KEY placeholder
            authDomain: "smartfarm-50e9f.firebaseapp.com", // Use YOUR_AUTH_DOMAIN placeholder
            databaseURL: "https://smartfarm-50e9f-default-rtdb.firebaseio.com",
            projectId: "smartfarm-50e9f", // Use YOUR_PROJECT_ID placeholder
            storageBucket: "smartfarm-50e9f.firebasestorage.app", // Use YOUR_STORAGE_BUCKET placeholder
            messagingSenderId: "615423373084", // Use YOUR_MESSAGING_SENDER_ID placeholder
            appId: "1:615423373084:web:e4af0444a7db2f9fa754d9", // Use YOUR_APP_ID placeholder
            measurementId: "G-8TDXE1451F"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);
        const auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // User is not signed in, redirect to login page
                window.location.href = 'login.html';
            }
        });

        // Function to update sensor values
        function updateSensorValue(elementId, value, unit) {
            const element = document.getElementById(elementId);
            if (element) {
                // Check if value is 0 or a valid number
                if (value === 0 || value === '0' || (value !== undefined && value !== null && value !== '--')) {
                    element.textContent = `${value}${unit}`;
                } else {
                    element.textContent = `--${unit}`;
                }
            }
        }

        // Function to update icons based on values
        function updateIcons(data) {
            const tempIcon = document.getElementById('tempIcon');
            const humidityIcon = document.getElementById('humidityIcon');
            const soilIcon = document.getElementById('soilIcon');
            const rainIcon = document.getElementById('rainIcon');
            const waterIcon = document.getElementById('waterIcon');
            const nitrogenIcon = document.getElementById('nitrogenIcon');
            const phosphorusIcon = document.getElementById('phosphorusIcon');
            const potassiumIcon = document.getElementById('potassiumIcon');

            const tempCard = tempIcon.closest('.card');
            const humidityCard = humidityIcon.closest('.card');
            const soilCard = soilIcon.closest('.card');
            const rainCard = rainIcon.closest('.card');
            const waterCard = waterIcon.closest('.card');
            const nitrogenCard = nitrogenIcon.closest('.card');
            const phosphorusCard = phosphorusIcon.closest('.card');
            const potassiumCard = potassiumIcon.closest('.card');

            // Temperature icon color
            if (data.temp > 30) {
                tempIcon.style.color = '#ff4444';
                tempCard.style.backgroundColor = '#ffebee';
            } else if (data.temp < 15) {
                tempIcon.style.color = '#4444ff';
                tempCard.style.backgroundColor = '#e8eaf6';
            } else {
                tempIcon.style.color = '#44ff44';
                tempCard.style.backgroundColor = '#e8f5e9';
            }

            // Humidity icon color
            if (data.humidity > 70) {
                humidityIcon.style.color = '#4444ff';
                humidityCard.style.backgroundColor = '#e8eaf6';
            } else if (data.humidity < 30) {
                humidityIcon.style.color = '#ff4444';
                humidityCard.style.backgroundColor = '#ffebee';
            } else {
                humidityIcon.style.color = '#44ff44';
                humidityCard.style.backgroundColor = '#e8f5e9';
            }

            // Soil moisture icon color
            if (data.soil > 70) {
                soilIcon.style.color = '#4444ff';
                soilCard.style.backgroundColor = '#e8eaf6';
            } else if (data.soil < 30) {
                soilIcon.style.color = '#ff4444';
                soilCard.style.backgroundColor = '#ffebee';
            } else {
                soilIcon.style.color = '#44ff44';
                soilCard.style.backgroundColor = '#e8f5e9';
            }

            // Rain icon color
            if (data.rain > 100) {
                rainIcon.style.color = '#4444ff';
                rainCard.style.backgroundColor = '#e8eaf6';
            } else if (data.rain < 20) {
                rainIcon.style.color = '#ff4444';
                rainCard.style.backgroundColor = '#ffebee';
            } else {
                rainIcon.style.color = '#44ff44';
                rainCard.style.backgroundColor = '#e8f5e9';
            }

            // Water level icon color
            if (data.water > 70) {
                waterIcon.style.color = '#44ff44';
                waterCard.style.backgroundColor = '#e8f5e9';
            } else if (data.water < 30) {
                waterIcon.style.color = '#ff4444';
                waterCard.style.backgroundColor = '#ffebee';
            } else {
                waterIcon.style.color = '#ffaa44';
                waterCard.style.backgroundColor = '#fff3e0';
            }

            // Nitrogen icon color
            if (data.N > 140) {
                nitrogenIcon.style.color = '#ff4444';
                nitrogenCard.style.backgroundColor = '#ffebee';
            } else if (data.N < 40) {
                nitrogenIcon.style.color = '#ffaa44';
                nitrogenCard.style.backgroundColor = '#fff3e0';
            } else {
                nitrogenIcon.style.color = '#44ff44';
                nitrogenCard.style.backgroundColor = '#e8f5e9';
            }

            // Phosphorus icon color
            if (data.P > 50) {
                phosphorusIcon.style.color = '#ff4444';
                phosphorusCard.style.backgroundColor = '#ffebee';
            } else if (data.P < 10) {
                phosphorusIcon.style.color = '#ffaa44';
                phosphorusCard.style.backgroundColor = '#fff3e0';
            } else {
                phosphorusIcon.style.color = '#44ff44';
                phosphorusCard.style.backgroundColor = '#e8f5e9';
            }

            // Potassium icon color
            if (data.K > 200) {
                potassiumIcon.style.color = '#ff4444';
                potassiumCard.style.backgroundColor = '#ffebee';
            } else if (data.K < 40) {
                potassiumIcon.style.color = '#ffaa44';
                potassiumCard.style.backgroundColor = '#fff3e0';
            } else {
                potassiumIcon.style.color = '#44ff44';
                potassiumCard.style.backgroundColor = '#e8f5e9';
            }
        }

        // Initialize charts with empty data
        let temperatureChart = null;
        let humidityChart = null;
        let soilChart = null;
        let nitrogenChart = null;
        let phosphorusChart = null;
        let potassiumChart = null;

        // Customize chart layouts
        const commonLayout = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: {
                color: '#2c3e50'
            },
            margin: {
                l: 50,
                r: 20,
                t: 50,
                b: 50
            },
            xaxis: {
                title: { text: 'Time' },
                showgrid: true,
                gridcolor: '#e0e0e0'
            },
            yaxis: {
                title: { text: 'Value' },
                showgrid: true,
                gridcolor: '#e0e0e0'
            }
        };

        // Function to update charts with data from Firebase
        function updateCharts(chartData) {
            if (chartData) {
                // Update temperature chart
                if (chartData.temperature_chart) {
                    const tempData = JSON.parse(chartData.temperature_chart);
                    if (!temperatureChart) {
                        temperatureChart = Plotly.newPlot('temperatureChart', tempData.data, {
                            ...tempData.layout,
                            ...commonLayout
                        });
                    } else {
                        Plotly.react('temperatureChart', tempData.data, {
                            ...tempData.layout,
                            ...commonLayout
                        });
                    }
                }

                // Update humidity chart
                if (chartData.humidity_chart) {
                    const humidityData = JSON.parse(chartData.humidity_chart);
                    if (!humidityChart) {
                        humidityChart = Plotly.newPlot('humidityChart', humidityData.data, {
                            ...humidityData.layout,
                            ...commonLayout
                        });
                    } else {
                        Plotly.react('humidityChart', humidityData.data, {
                            ...humidityData.layout,
                            ...commonLayout
                        });
                    }
                }

                // Update soil chart
                if (chartData.soil_chart) {
                    const soilData = JSON.parse(chartData.soil_chart);
                    if (!soilChart) {
                        soilChart = Plotly.newPlot('soilChart', soilData.data, {
                            ...soilData.layout,
                            ...commonLayout
                        });
                    } else {
                        Plotly.react('soilChart', soilData.data, {
                            ...soilData.layout,
                            ...commonLayout
                        });
                    }
                }

                // Update nitrogen chart
                if (chartData.nitrogen_chart) {
                    const nitrogenData = JSON.parse(chartData.nitrogen_chart);
                    if (!nitrogenChart) {
                        nitrogenChart = Plotly.newPlot('nitrogenChart', nitrogenData.data, {
                            ...nitrogenData.layout,
                            ...commonLayout
                        });
                    } else {
                        Plotly.react('nitrogenChart', nitrogenData.data, {
                            ...nitrogenData.layout,
                            ...commonLayout
                        });
                    }
                }

                // Update phosphorus chart
                if (chartData.phosphorus_chart) {
                    const phosphorusData = JSON.parse(chartData.phosphorus_chart);
                    if (!phosphorusChart) {
                        phosphorusChart = Plotly.newPlot('phosphorusChart', phosphorusData.data, {
                            ...phosphorusData.layout,
                            ...commonLayout
                        });
                    } else {
                        Plotly.react('phosphorusChart', phosphorusData.data, {
                            ...phosphorusData.layout,
                            ...commonLayout
                        });
                    }
                }

                // Update potassium chart
                if (chartData.potassium_chart) {
                    const potassiumData = JSON.parse(chartData.potassium_chart);
                    if (!potassiumChart) {
                        potassiumChart = Plotly.newPlot('potassiumChart', potassiumData.data, {
                            ...potassiumData.layout,
                            ...commonLayout
                        });
                    } else {
                        Plotly.react('potassiumChart', potassiumData.data, {
                            ...potassiumData.layout,
                            ...commonLayout
                        });
                    }
                }
            }
        }

        // Listen for real-time updates
        const sensorsRef = ref(database, 'sensor');
        const chartsRef = ref(database, 'charts');
        
        // Listen for sensor data updates
        onValue(sensorsRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                updateSensorValue('temperature', data.temp || '--', '°C');
                updateSensorValue('humidity', data.humidity || '--', '%');
                updateSensorValue('soilMoisture', data.soil || '--', '%');
                updateSensorValue('rainLevel', data.rain !== undefined ? data.rain : '--', 'mm');
                updateSensorValue('waterLevel', data.water || '--', '%');
                updateSensorValue('nitrogen', data.N !== undefined ? data.N : '--', 'mg/kg');
                updateSensorValue('phosphorus', data.P !== undefined ? data.P : '--', 'mg/kg');
                updateSensorValue('potassium', data.K !== undefined ? data.K : '--', 'mg/kg');
                updateIcons(data);
            }
        }, (error) => {
            console.error("Error reading sensor data:", error);
        });

        // Listen for chart data updates
        onValue(chartsRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                updateCharts(data);
            }
        }, (error) => {
            console.error("Error reading chart data:", error);
        });
    </script>
</body>
</html>
