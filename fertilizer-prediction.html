<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartFarm - Fertilizer Prediction</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltip-content {
            visibility: hidden;
            width: 250px;
            background-color: #333;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            line-height: 1.4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .tooltip .tooltip-content::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }

        .tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }

        .help-icon {
            color: #6B7280;
            cursor: help;
            transition: color 0.2s;
        }

        .help-icon:hover {
            color: #4B5563;
        }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                <div class="logo">
                    <i class="fas fa-leaf"></i>
                    <span>SmartFarm</span>
                </div>
            </a>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="dashboard.html">Dashboard</a>
                <a href="pump.html">Pump</a>
                <div class="dropdown">
                    <a href="#" class="dropdown-trigger">Predict</a>
                    <div class="dropdown-content">
                        <a href="crop-prediction.html">Crop</a>
                        <a href="fertilizer-prediction.html" class="active">Fertilizer</a>
                        <a href="yield-prediction.html">Yield</a>
                    </div>
                </div>
                <a href="disease-detection.html">Disease</a>
                <a href="chatbot.html">Chat</a>
                <a href="about.html">About</a>
            </div>
            <div class="auth-controls">
                <span id="greeting">Hello, Ziad</span>
                <button id="logoutBtn" class="btn-logout">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                    <i class="fas fa-seedling text-green-500 mr-3"></i>
                    Fertilizer Prediction System
                </h1>
                <div class="tooltip">
                    <i class="fas fa-question-circle text-xl help-icon"></i>
                    <div class="tooltip-content">
                        <strong>How to use this system:</strong><br>
                        1. Enter your soil's NPK values<br>
                        2. Input pH level and environmental data<br>
                        3. Select your crop<br>
                        4. Click "Get Recommendations"<br>
                        <br>
                        <strong>Tips:</strong><br>
                        • Use the "Fetch Sensor Data" button to get real-time environmental data<br>
                        • Check the info icons for valid ranges<br>
                        • View your prediction history below
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <form id="fertilizerPredictionForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Nitrogen -->
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Nitrogen (N)
                                <div class="tooltip inline-block ml-1">
                                    <i class="fas fa-info-circle help-icon"></i>
                                    <div class="tooltip-content">
                                        <strong>Nitrogen (N)</strong><br>
                                        Essential for leaf growth and green color.<br>
                                        • Range: 20-150 kg/ha<br>
                                        • Low: Yellow leaves, stunted growth<br>
                                        • High: Excessive foliage, delayed fruiting
                                    </div>
                                </div>
                            </label>
                            <input type="number" id="nitrogen" name="nitrogen" min="20" max="150" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <!-- Phosphorus -->
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Phosphorus (P)
                                <div class="tooltip inline-block ml-1">
                                    <i class="fas fa-info-circle help-icon"></i>
                                    <div class="tooltip-content">
                                        <strong>Phosphorus (P)</strong><br>
                                        Vital for root development and flowering.<br>
                                        • Range: 10-90 kg/ha<br>
                                        • Low: Poor root growth, delayed maturity<br>
                                        • High: Reduced micronutrient availability
                                    </div>
                                </div>
                            </label>
                            <input type="number" id="phosphorus" name="phosphorus" min="10" max="90" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <!-- Potassium -->
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Potassium (K)
                                <div class="tooltip inline-block ml-1">
                                    <i class="fas fa-info-circle help-icon"></i>
                                    <div class="tooltip-content">
                                        <strong>Potassium (K)</strong><br>
                                        Important for fruit quality and disease resistance.<br>
                                        • Range: 10-90 kg/ha<br>
                                        • Low: Weak stems, poor fruit quality<br>
                                        • High: Reduced calcium uptake
                                    </div>
                                </div>
                            </label>
                            <input type="number" id="potassium" name="potassium" min="10" max="90" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <!-- pH -->
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                pH Level
                                <div class="tooltip inline-block ml-1">
                                    <i class="fas fa-info-circle help-icon"></i>
                                    <div class="tooltip-content">
                                        <strong>Soil pH</strong><br>
                                        Affects nutrient availability.<br>
                                        • Range: 3.5-10<br>
                                        • Acidic (< 6.0): Good for blueberries, potatoes<br>
                                        • Neutral (6.0-7.5): Most crops<br>
                                        • Alkaline (> 7.5): Good for asparagus, cabbage
                                    </div>
                                </div>
                            </label>
                            <input type="number" id="ph" name="ph" min="3.5" max="10" step="0.1" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <!-- Rainfall -->
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Rainfall (mm)
                                <div class="tooltip inline-block ml-1">
                                    <i class="fas fa-info-circle help-icon"></i>
                                    <div class="tooltip-content">
                                        <strong>Rainfall</strong><br>
                                        Annual precipitation in millimeters.<br>
                                        • Range: 20-300 mm<br>
                                        • Affects nutrient leaching<br>
                                        • Consider seasonal distribution
                                    </div>
                                </div>
                            </label>
                            <input type="number" id="rainfall" name="rainfall" min="20" max="300" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <!-- Temperature -->
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Temperature (°C)
                                <div class="tooltip inline-block ml-1">
                                    <i class="fas fa-info-circle help-icon"></i>
                                    <div class="tooltip-content">
                                        <strong>Temperature</strong><br>
                                        Average temperature in Celsius.<br>
                                        • Range: 8-44°C<br>
                                        • Affects nutrient uptake<br>
                                        • Consider seasonal variations
                                    </div>
                                </div>
                            </label>
                            <input type="number" id="temperature" name="temperature" min="8" max="44" step="0.1" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <!-- Crop Selection -->
                        <div class="form-group md:col-span-2 lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Select Crop
                                <div class="tooltip inline-block ml-1">
                                    <i class="fas fa-info-circle help-icon"></i>
                                    <div class="tooltip-content">
                                        <strong>Crop Selection</strong><br>
                                        Choose the crop you want to grow.<br>
                                        • Different crops have different nutrient needs<br>
                                        • Consider crop rotation<br>
                                        • Check local growing conditions
                                    </div>
                                </div>
                            </label>
                            <select id="crop" name="crop" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">Select a crop...</option>
                                <!-- Options will be populated from Firebase -->
                            </select>
                        </div>
                    </div>

                    <div class="flex justify-center space-x-4">
                        <button type="submit" class="btn btn-primary flex items-center">
                            <i class="fas fa-magic mr-2"></i>
                            Get Fertilizer Recommendations
                        </button>
                        <button type="button" id="fetchFirebaseDataBtn" class="btn btn-outline flex items-center">
                            <i class="fas fa-cloud-download-alt mr-2"></i>
                            Fetch Sensor Data
                        </button>
                    </div>
                </form>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="hidden">
                <div class="flex justify-center items-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500"></div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden w-full">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Recommended Fertilizers</h2>
                <div id="fertilizerResults" class="w-full">
                    <!-- Results will be dynamically inserted here -->
                </div>
            </div>

            <!-- History Section -->
            <div id="historySection" class="mt-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Prediction History</h2>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-700">Recent Predictions</h3>
                        <button id="clearHistoryBtn" class="text-sm text-red-500 hover:text-red-700">
                            <i class="fas fa-trash-alt mr-1"></i>Clear History
                        </button>
                    </div>
                    <div id="predictionHistory" class="space-y-4">
                        <!-- History items will be dynamically inserted here -->
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mt-4" role="alert">
                <span class="block sm:inline"></span>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDL2h9dxXjU-2a6lEwK-iR2AL76FHLGc88",
            authDomain: "smartfarm-50e9f.firebaseapp.com",
            databaseURL: "https://smartfarm-50e9f-default-rtdb.firebaseio.com",
            projectId: "smartfarm-50e9f",
            storageBucket: "smartfarm-50e9f.firebasestorage.app",
            messagingSenderId: "615423373084",
            appId: "1:615423373084:web:e4af0444a7db2f9fa754d9",
            measurementId: "G-8TDXE1451F"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // Check authentication state
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
            }
        });

        // Populate crop dropdown from Firebase
        async function populateCropDropdown() {
            try {
                const controlPlantRef = ref(database, 'control/plant');
                const snapshot = await get(controlPlantRef);
                const cropSelect = document.getElementById('crop');
                
                if (snapshot.exists()) {
                    const currentCrop = snapshot.val();
                    const option = document.createElement('option');
                    option.value = currentCrop;
                    option.textContent = currentCrop;
                    option.selected = true;
                    cropSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error fetching crop data:', error);
            }
        }

        // Fetch sensor data from Firebase
        async function fetchSensorData() {
            try {
                document.getElementById('loadingSpinner').classList.remove('hidden');
                document.getElementById('errorMessage').classList.add('hidden');

                const sensorRef = ref(database, 'sensor');
                const snapshot = await get(sensorRef);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    document.getElementById('temperature').value = data.temp !== undefined ? data.temp : '';
                    document.getElementById('rainfall').value = data.rain !== undefined ? data.rain : '';
                    alert('Temperature and Rainfall data fetched from Firebase.');
                } else {
                    alert('No sensor data available in Firebase to fetch.');
                }
            } catch (error) {
                console.error('Error fetching sensor data:', error);
                document.getElementById('errorMessage').classList.remove('hidden');
                document.getElementById('errorMessage').querySelector('span').textContent = 
                    'Failed to fetch sensor data. Please try again.';
            } finally {
                document.getElementById('loadingSpinner').classList.add('hidden');
            }
        }

        // Initialize the page
        populateCropDropdown();

        // Input validation function
        function validateInput(input, min, max, step = 1) {
            const value = parseFloat(input.value);
            const errorElement = input.nextElementSibling;
            
            if (isNaN(value)) {
                showError(input, 'Please enter a valid number');
                return false;
            }
            
            if (value < min || value > max) {
                showError(input, `Value must be between ${min} and ${max}`);
                return false;
            }
            
            if (step !== 1 && (value % step) !== 0) {
                showError(input, `Value must be in increments of ${step}`);
                return false;
            }
            
            hideError(input);
            return true;
        }

        function showError(input, message) {
            let errorElement = input.nextElementSibling;
            if (!errorElement || !errorElement.classList.contains('error-message')) {
                errorElement = document.createElement('div');
                errorElement.className = 'error-message text-red-500 text-sm mt-1';
                input.parentNode.insertBefore(errorElement, input.nextSibling);
            }
            errorElement.textContent = message;
            input.classList.add('border-red-500');
        }

        function hideError(input) {
            const errorElement = input.nextElementSibling;
            if (errorElement && errorElement.classList.contains('error-message')) {
                errorElement.remove();
            }
            input.classList.remove('border-red-500');
        }

        // Add real-time validation to all numeric inputs
        const numericInputs = document.querySelectorAll('input[type="number"]');
        numericInputs.forEach(input => {
            input.addEventListener('input', () => {
                const min = parseFloat(input.min);
                const max = parseFloat(input.max);
                const step = parseFloat(input.step) || 1;
                validateInput(input, min, max, step);
            });
        });

        // Add validation to crop selection
        const cropSelect = document.getElementById('crop');
        cropSelect.addEventListener('change', () => {
            if (!cropSelect.value) {
                showError(cropSelect, 'Please select a crop');
            } else {
                hideError(cropSelect);
            }
        });

        // History management functions
        function saveToHistory(prediction) {
            let history = JSON.parse(localStorage.getItem('fertilizerHistory') || '[]');
            history.unshift({
                ...prediction,
                timestamp: new Date().toISOString()
            });
            // Keep only last 10 predictions
            history = history.slice(0, 10);
            localStorage.setItem('fertilizerHistory', JSON.stringify(history));
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const historyContainer = document.getElementById('predictionHistory');
            const history = JSON.parse(localStorage.getItem('fertilizerHistory') || '[]');
            
            if (history.length === 0) {
                historyContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No prediction history available</p>';
                return;
            }

            historyContainer.innerHTML = history.map(item => `
                <div class="border-b border-gray-200 pb-4 last:border-0">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold text-gray-800">${item.Crop}</h4>
                            <p class="text-sm text-gray-600">Recommended: ${item.fertilizer}</p>
                            <div class="text-xs text-gray-500 mt-1">
                                N: ${item.Nitrogen} | P: ${item.Phosphorus} | K: ${item.Potassium} | pH: ${item.pH}
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${new Date(item.timestamp).toLocaleString()}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Clear history
        document.getElementById('clearHistoryBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all prediction history?')) {
                localStorage.removeItem('fertilizerHistory');
                updateHistoryDisplay();
            }
        });

        // Initialize history display
        updateHistoryDisplay();

        // Modify the form submission to save to history
        document.getElementById('fertilizerPredictionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validate all inputs
            let isValid = true;
            numericInputs.forEach(input => {
                const min = parseFloat(input.min);
                const max = parseFloat(input.max);
                const step = parseFloat(input.step) || 1;
                if (!validateInput(input, min, max, step)) {
                    isValid = false;
                }
            });

            if (!cropSelect.value) {
                showError(cropSelect, 'Please select a crop');
                isValid = false;
            }

            if (!isValid) {
                return;
            }

            document.getElementById('loadingSpinner').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');

            const formData = {
                "Nitrogen": parseFloat(document.getElementById('nitrogen').value),
                "Phosphorus": parseFloat(document.getElementById('phosphorus').value),
                "Potassium": parseFloat(document.getElementById('potassium').value),
                "pH": parseFloat(document.getElementById('ph').value),
                "Rainfall": parseFloat(document.getElementById('rainfall').value),
                "Temperature": parseFloat(document.getElementById('temperature').value),
                "Crop": document.getElementById('crop').value
            };

            try {
                console.log('Sending request with data:', formData);
                
                // First try a simple fetch without any special headers
                const response = await fetch('https://zidea21-fertilizer-prediction.hf.space/predict_fertilizer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                }).catch(error => {
                    console.error('Fetch error:', error);
                    throw new Error(`Network error: ${error.message}`);
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response text:', errorText);
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        console.error('Failed to parse error response as JSON:', e);
                    }
                    throw new Error(errorData?.detail || errorData?.message || `HTTP error! status: ${response.status}`);
                }

                const responseText = await response.text();
                console.log('Raw response:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error('Failed to parse response as JSON:', e);
                    throw new Error('Invalid JSON response from server');
                }
                
                console.log('Parsed response data:', data);
                
                if (!data || !data.fertilizer) {
                    throw new Error('Invalid response format from API');
                }
                
                // Display results
                const resultsContainer = document.getElementById('fertilizerResults');
                resultsContainer.innerHTML = '';

                // Create a card styled like the plant disease results
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-lg p-6 w-full';
                card.innerHTML = `
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Analysis Results</h2>
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-xl font-semibold text-gray-800">Primary Recommendation</h3>
                            <span class="text-2xl font-bold text-green-500">${data.fertilizer}</span>
                        </div>
                        <div class="bg-gray-100 rounded-lg p-4">
                            <p class="text-lg" id="fertilizerMain">${data.fertilizer}</p>
                        </div>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Usage Guide</h3>
                    <div id="fertilizerDetails" class="mt-4 p-4 bg-blue-50 rounded-lg text-gray-700">
                        <span>Loading usage guide...</span>
                    </div>
                `;
                resultsContainer.appendChild(card);

                // Fetch detailed usage guide from Gemini
                const geminiPrompt = `You are an expert agronomist. Given the following details, provide a short, practical usage guide for the fertilizer recommendation.\nFertilizer: ${data.fertilizer}\nCrop: ${formData.Crop}\nSoil N: ${formData.Nitrogen}, P: ${formData.Phosphorus}, K: ${formData.Potassium}, pH: ${formData.pH}\nRainfall: ${formData.Rainfall} mm, Temperature: ${formData.Temperature}°C.\nInclude: 1. Application rate, 2. Best timing, 3. Safety tips.\nAnswer in 3-5 sentences, clear and practical for a farmer.`;
                try {
                    const geminiResponse = await fetch('https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key=AIzaSyCwWUf8HN6IUOjr1v0yzGJQ6hPsL3U3tLY', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: geminiPrompt }] }],
                            generationConfig: {
                                temperature: 0.7,
                                topK: 40,
                                topP: 0.95,
                                maxOutputTokens: 256,
                            }
                        })
                    });
                    const geminiData = await geminiResponse.json();
                    let geminiText = '';
                    if (geminiData.candidates && geminiData.candidates[0]?.content?.parts?.[0]?.text) {
                        geminiText = geminiData.candidates[0].content.parts[0].text;
                    }
                    document.getElementById('fertilizerDetails').innerHTML = geminiText ? geminiText : 'No usage guide available.';
                } catch (e) {
                    document.getElementById('fertilizerDetails').innerHTML = 'No usage guide available.';
                }

                document.getElementById('resultsSection').classList.remove('hidden');

                // After successful prediction, save to history
                saveToHistory({
                    ...formData,
                    fertilizer: data.fertilizer
                });
            } catch (error) {
                document.getElementById('errorMessage').classList.remove('hidden');
                let errorMessageText = 'Failed to get fertilizer recommendations. Please try again.';
                if (error.response && error.response.json) {
                    try {
                        const errorData = await error.response.json();
                        if (errorData.detail) {
                            errorMessageText = `API Error: ${errorData.detail}`;
                        } else if (errorData.message) {
                            errorMessageText = `API Error: ${errorData.message}`;
                        } else {
                            errorMessageText = `API Error: ${JSON.stringify(errorData)}`;
                        }
                    } catch (jsonError) {
                        errorMessageText = `Network Error: ${error.message}`;
                    }
                } else {
                    errorMessageText = `Network Error: ${error.message}`;
                }
                document.getElementById('errorMessage').querySelector('span').textContent = errorMessageText;
            } finally {
                document.getElementById('loadingSpinner').classList.add('hidden');
            }
        });

        // Add event listener for fetch sensor data button
        document.getElementById('fetchFirebaseDataBtn').addEventListener('click', fetchSensorData);
    </script>
</body>
</html> 