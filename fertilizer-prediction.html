<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartFarm - Fertilizer Prediction</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                <div class="logo">
                    <i class="fas fa-leaf"></i>
                    <span>SmartFarm</span>
                </div>
            </a>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="dashboard.html">Dashboard</a>
                <a href="pump.html">Pump Control</a>
                <a href="crop-prediction.html">Crop Prediction</a>
                <a href="fertilizer-prediction.html" class="active">Fertilizer Prediction</a>
                <a href="disease-detection.html">Disease Detection</a>
                <a href="about.html">About Us</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-8 flex items-center">
                <i class="fas fa-flask text-green-500 mr-3"></i>
                Fertilizer Recommendation System
            </h1>

            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <form id="fertilizerPredictionForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Nitrogen -->
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Nitrogen (N)
                                <i class="fas fa-info-circle text-gray-400 ml-1" title="Nitrogen content in soil (20-150 kg/ha)"></i>
                            </label>
                            <input type="number" id="nitrogen" name="nitrogen" min="20" max="150" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <!-- Phosphorus -->
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Phosphorus (P)
                                <i class="fas fa-info-circle text-gray-400 ml-1" title="Phosphorus content in soil (10-90 kg/ha)"></i>
                            </label>
                            <input type="number" id="phosphorus" name="phosphorus" min="10" max="90" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <!-- Potassium -->
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Potassium (K)
                                <i class="fas fa-info-circle text-gray-400 ml-1" title="Potassium content in soil (5-150 kg/ha)"></i>
                            </label>
                            <input type="number" id="potassium" name="potassium" min="5" max="150" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <!-- pH -->
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                pH Level
                                <i class="fas fa-info-circle text-gray-400 ml-1" title="Soil pH level (5.5-8.5)"></i>
                            </label>
                            <input type="number" id="ph" name="ph" min="5.5" max="8.5" step="0.1" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <!-- Rainfall -->
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Rainfall (mm)
                                <i class="fas fa-info-circle text-gray-400 ml-1" title="Rainfall in millimeters (300-1700)"></i>
                            </label>
                            <input type="number" id="rainfall" name="rainfall" min="300" max="1700" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <!-- Temperature -->
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Temperature (Â°C)
                                <i class="fas fa-info-circle text-gray-400 ml-1" title="Temperature in Celsius (10-40)"></i>
                            </label>
                            <input type="number" id="temperature" name="temperature" min="10" max="40" step="0.1" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>

                        <!-- Crop Selection -->
                        <div class="form-group md:col-span-2 lg:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Select Crop
                                <i class="fas fa-info-circle text-gray-400 ml-1" title="Choose the crop you want to grow"></i>
                            </label>
                            <select id="crop" name="crop" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">Select a crop...</option>
                                <!-- Options will be populated from Firebase -->
                            </select>
                        </div>
                    </div>

                    <div class="flex justify-center space-x-4">
                        <button type="submit" class="btn btn-primary flex items-center">
                            <i class="fas fa-magic mr-2"></i>
                            Get Fertilizer Recommendations
                        </button>
                        <button type="button" id="fetchFirebaseDataBtn" class="btn btn-outline flex items-center">
                            <i class="fas fa-cloud-download-alt mr-2"></i>
                            Fetch Sensor Data
                        </button>
                    </div>
                </form>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="hidden">
                <div class="flex justify-center items-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500"></div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Recommended Fertilizers</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="fertilizerResults">
                    <!-- Results will be dynamically inserted here -->
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mt-4" role="alert">
                <span class="block sm:inline"></span>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-brand">
                <div class="footer-logo">
                    <i class="fas fa-leaf"></i>
                    <span>SmartFarm</span>
                </div>
                <p class="footer-tagline">Revolutionizing agriculture with smart technology</p>
                <div class="social-links">
                    <a href="#" class="social-link"><i class="fab fa-facebook"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-linkedin"></i></a>
                    <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
            <div class="footer-contact">
                <h3>Contact Us</h3>
                <div class="contact-item">
                    <i class="fas fa-envelope"></i>
                    <a href="mailto:info@smartfarm.com">info@smartfarm.com</a>
                </div>
                <div class="contact-item">
                    <i class="fas fa-phone"></i>
                    <a href="tel:+1234567890">(123) 456-7890</a>
                </div>
                <div class="contact-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>123 Smart Farm Street, Tech City, TC 12345</span>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 SmartFarm. All rights reserved.</p>
            <div class="footer-links">
                <a href="privacy-policy.html">Privacy Policy</a>
                <a href="terms-of-service.html">Terms of Service</a>
                <a href="cookie-policy.html">Cookie Policy</a>
            </div>
        </div>
    </footer>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDL2h9dxXjU-2a6lEwK-iR2AL76FHLGc88",
            authDomain: "smartfarm-50e9f.firebaseapp.com",
            databaseURL: "https://smartfarm-50e9f-default-rtdb.firebaseio.com",
            projectId: "smartfarm-50e9f",
            storageBucket: "smartfarm-50e9f.firebasestorage.app",
            messagingSenderId: "615423373084",
            appId: "1:615423373084:web:e4af0444a7db2f9fa754d9",
            measurementId: "G-8TDXE1451F"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        // Check authentication state
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
            }
        });

        // Populate crop dropdown from Firebase
        async function populateCropDropdown() {
            try {
                const controlPlantRef = ref(database, 'control/plant');
                const snapshot = await get(controlPlantRef);
                const cropSelect = document.getElementById('crop');
                
                if (snapshot.exists()) {
                    const currentCrop = snapshot.val();
                    const option = document.createElement('option');
                    option.value = currentCrop;
                    option.textContent = currentCrop;
                    option.selected = true;
                    cropSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error fetching crop data:', error);
            }
        }

        // Fetch sensor data from Firebase
        async function fetchSensorData() {
            try {
                document.getElementById('loadingSpinner').classList.remove('hidden');
                document.getElementById('errorMessage').classList.add('hidden');

                const sensorRef = ref(database, 'sensor'); // Changed from 'sensors' to 'sensor'
                const snapshot = await get(sensorRef);
                
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    // Map the sensor data to the form fields
                    document.getElementById('temperature').value = data.temp !== undefined ? data.temp : '';
                    document.getElementById('rainfall').value = data.rain !== undefined ? data.rain : '';
                    // Note: nitrogen, phosphorus, potassium, and pH are not available in the sensor data
                    // These will need to be entered manually
                    alert('Temperature and Rainfall data fetched from Firebase. Please manually enter Nitrogen, Phosphorus, Potassium, and pH values.');
                } else {
                    alert('No sensor data available in Firebase to fetch.');
                }
            } catch (error) {
                console.error('Error fetching sensor data:', error);
                document.getElementById('errorMessage').classList.remove('hidden');
                document.getElementById('errorMessage').querySelector('span').textContent = 
                    'Failed to fetch sensor data. Please try again.';
            } finally {
                document.getElementById('loadingSpinner').classList.add('hidden');
            }
        }

        // Initialize the page
        populateCropDropdown();

        // Add event listeners
        document.getElementById('fertilizerPredictionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            document.getElementById('loadingSpinner').classList.remove('hidden');
            document.getElementById('resultsSection').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');

            const formData = {
                "Nitrogen": parseFloat(document.getElementById('nitrogen').value),
                "Phosphorus": parseFloat(document.getElementById('phosphorus').value),
                "Potassium": parseFloat(document.getElementById('potassium').value),
                "pH": parseFloat(document.getElementById('ph').value),
                "Rainfall": parseFloat(document.getElementById('rainfall').value),
                "Temperature": parseFloat(document.getElementById('temperature').value),
                "Crop": document.getElementById('crop').value
            };

            try {
                console.log('Sending request with data:', formData);
                const response = await fetch('https://fertilizer-bggud3eeegdtathx.uaenorth-01.azurewebsites.net/predict_fertilizer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Access-Control-Allow-Origin': '*'
                    },
                    mode: 'cors',
                    body: JSON.stringify(formData)
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    console.error('Error response:', errorData);
                    throw new Error(errorData?.detail || errorData?.message || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Response data:', data);
                
                if (!data || !data.fertilizer) {
                    throw new Error('Invalid response format from API');
                }
                
                // Display results
                const resultsContainer = document.getElementById('fertilizerResults');
                resultsContainer.innerHTML = '';

                // Create a card for the recommended fertilizer
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md p-6 transform transition-transform hover:scale-105';
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Recommended Fertilizer</h3>
                        <span class="text-2xl font-bold text-green-500">${data.fertilizer}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-green-500 h-2.5 rounded-full" style="width: 100%"></div>
                    </div>
                    <button class="btn btn-secondary mt-4 w-full save-fertilizer-btn" data-fertilizer="${data.fertilizer}">
                        Save to Firebase
                    </button>
                `;
                resultsContainer.appendChild(card);

                // Add event listener to save button
                document.querySelector('.save-fertilizer-btn').addEventListener('click', async (event) => {
                    const fertilizer = event.target.dataset.fertilizer;
                    if (confirm(`Are you sure you want to save ${fertilizer} as the recommended fertilizer?`)) {
                        try {
                            const fertilizerRef = ref(database, 'control/fertilizer');
                            await set(fertilizerRef, fertilizer);
                            alert(`${fertilizer} has been successfully saved to Firebase!`);
                        } catch (error) {
                            document.getElementById('errorMessage').classList.remove('hidden');
                            document.getElementById('errorMessage').querySelector('span').textContent = 
                                `Failed to save fertilizer to Firebase: ${error.message}`;
                        }
                    }
                });

                document.getElementById('resultsSection').classList.remove('hidden');
            } catch (error) {
                document.getElementById('errorMessage').classList.remove('hidden');
                let errorMessageText = 'Failed to get fertilizer recommendations. Please try again.';
                if (error.response && error.response.json) {
                    try {
                        const errorData = await error.response.json();
                        if (errorData.detail) {
                            errorMessageText = `API Error: ${errorData.detail}`;
                        } else if (errorData.message) {
                            errorMessageText = `API Error: ${errorData.message}`;
                        } else {
                            errorMessageText = `API Error: ${JSON.stringify(errorData)}`;
                        }
                    } catch (jsonError) {
                        errorMessageText = `Network Error: ${error.message}`;
                    }
                } else {
                    errorMessageText = `Network Error: ${error.message}`;
                }
                document.getElementById('errorMessage').querySelector('span').textContent = errorMessageText;
            } finally {
                document.getElementById('loadingSpinner').classList.add('hidden');
            }
        });

        // Add event listener for fetch sensor data button
        document.getElementById('fetchFirebaseDataBtn').addEventListener('click', fetchSensorData);
    </script>
</body>
</html> 