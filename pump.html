<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartFarm - Pump Control</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Common JavaScript -->
    <script src="common.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                <div class="logo">
                    <i class="fas fa-leaf"></i>
                    <span>SmartFarm</span>
                </div>
            </a>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="dashboard.html">Dashboard</a>
                <a href="pump.html" class="active">Pump</a>
                <div class="dropdown">
                    <a href="#" class="dropdown-trigger">Predict</a>
                    <div class="dropdown-content">
                        <a href="crop-prediction.html">Crop</a>
                        <a href="fertilizer-prediction.html">Fertilizer</a>
                        <a href="yield-prediction.html">Yield</a>
                    </div>
                </div>
                <a href="disease-detection.html">Disease</a>
                <a href="chatbot.html">Chat</a>
                <a href="about.html">About</a>
            </div>
            <div class="auth-controls">
                <span id="greeting">Hello, Ziad</span>
                <button id="logoutBtn" class="btn-logout">Logout</button>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <h1>Smart Pump Control</h1>
        
        <div class="pump-status-section">
            <div class="status-card">
                <div class="status-icon">
                    <i class="fas fa-power-off" id="pumpStatusIcon"></i>
                </div>
                <div class="status-info">
                    <h3>Pump Status</h3>
                    <p id="pumpStatus">Checking...</p>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon">
                    <i class="fas fa-clock" id="lastRunIcon"></i>
                </div>
                <div class="status-info">
                    <h3>Last Run</h3>
                    <p id="lastRunTime">--:--</p>
                </div>
            </div>
            <div class="status-card">
                <div class="status-icon">
                    <i class="fas fa-tint" id="waterLevelIcon"></i>
                </div>
                <div class="status-info">
                    <h3>Water Level</h3>
                    <p id="waterLevel">--%</p>
                </div>
            </div>
        </div>

        <div class="control-section">
            <div class="control-card manual-mode" id="manualControl">
                <h2>Manual Control</h2>
                <div class="control-options">
                    <div class="control-group">
                        <label class="toggle-switch">
                            <input type="checkbox" id="pumpToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="control-label">Pump Power</span>
                    </div>
                    <div class="control-group">
                        <label for="pumpDuration">Duration (minutes)</label>
                        <input type="number" id="pumpDuration" min="1" max="60" value="5">
                    </div>
                    <button class="btn btn-primary" id="startPump">
                        <i class="fas fa-play"></i> Start Pump
                    </button>
                </div>
            </div>

            <div class="control-card auto-mode">
                <h2>Automatic Mode</h2>
                <div class="control-options">
                    <div class="control-group">
                        <label class="toggle-switch">
                            <input type="checkbox" id="autoModeToggle">
                            <span class="slider"></span>
                        </label>
                        <span class="control-label">Enable Auto Mode</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="schedule-section">
            <h2>Irrigation Schedule</h2>
            <div class="schedule-card">
                <div class="schedule-header">
                    <h3>Today's Schedule</h3>
                    <div class="flex space-x-4 mb-4">
                        <input type="time" id="scheduleTime" class="p-2 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 flex-grow">
                        <input type="number" id="scheduleDuration" min="1" placeholder="Duration (min)" class="p-2 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 w-32">
                    </div>
                    <button class="btn btn-outline w-full" id="addSchedule">
                        <i class="fas fa-plus mr-2"></i> Add Schedule
                    </button>
                </div>
                <div class="schedule-list mt-4" id="scheduleList">
                    <!-- Schedule items will be added here dynamically -->
                </div>
            </div>
        </div>

        <div class="history-section">
            <h2>Pump Activity History</h2>
            <div class="history-card">
                <div class="history-filters">
                    <select id="historyFilter">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
                <div class="history-list" id="historyList">
                    <!-- History items will be added here dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, update, push, child, remove } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDL2h9dxXjU-2a6lEwK-iR2AL76FHLGc88",
            authDomain: "smartfarm-50e9f.firebaseapp.com",
            databaseURL: "https://smartfarm-50e9f-default-rtdb.firebaseio.com",
            projectId: "smartfarm-50e9f",
            storageBucket: "smartfarm-50e9f.firebasestorage.app",
            messagingSenderId: "615423373084",
            appId: "1:615423373084:web:e4af0444a7db2f9fa754d9",
            measurementId: "G-8TDXE1451F"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // User is not signed in, redirect to login page
                window.location.href = 'login.html';
            }
        });

        // DOM Elements
        const pumpToggle = document.getElementById('pumpToggle');
        const autoModeToggle = document.getElementById('autoModeToggle');
        const startPumpBtn = document.getElementById('startPump');
        const pumpStatus = document.getElementById('pumpStatus');
        const pumpStatusIcon = document.getElementById('pumpStatusIcon');
        const lastRunTime = document.getElementById('lastRunTime');
        const waterLevel = document.getElementById('waterLevel');
        const historyList = document.getElementById('historyList');
        const historyFilter = document.getElementById('historyFilter');

        // New DOM elements for scheduling
        const scheduleTimeInput = document.getElementById('scheduleTime');
        const scheduleDurationInput = document.getElementById('scheduleDuration');
        const addScheduleBtn = document.getElementById('addSchedule');
        const scheduleList = document.getElementById('scheduleList');

        let pumpStartTime = null;
        let currentPumpTimeout = null; // To store timeout ID for scheduled pump off

        // Function to update pump status
        function updatePumpStatus(status, source = 'manual') {
            pumpStatus.textContent = status ? 'Running' : 'Stopped';
            pumpStatusIcon.style.color = status ? '#2ecc71' : '#e74c3c';
            pumpToggle.checked = status;
            
            // Update control/pump value
            const controlPumpRef = ref(database, 'control/pump');
            set(controlPumpRef, status ? 1 : 0);

            // Record pump history
            if (status) {
                // Pump turned ON
                pumpStartTime = new Date().getTime();
            } else {
                // Pump turned OFF
                if (pumpStartTime) {
                    const endTime = new Date().getTime();
                    const durationMinutes = ((endTime - pumpStartTime) / (1000 * 60)); // Calculate duration precisely

                    const pumpHistoryRef = ref(database, 'pumpHistory');
                    const newHistoryEntryRef = push(pumpHistoryRef); // Generate unique key
                    set(newHistoryEntryRef, {
                        startTime: pumpStartTime,
                        endTime: endTime,
                        duration: parseFloat(durationMinutes.toFixed(1)), // Keep one decimal place
                        status: 'OFF',
                        triggerType: source // Add trigger type to history
                    });
                    pumpStartTime = null; // Reset start time
                }
            }
        }

        // Function to update automatic mode
        function updateAutoMode(enabled) {
            autoModeToggle.checked = enabled;
            // Update control/automatic value
            const controlAutoRef = ref(database, 'control/automatic');
            set(controlAutoRef, enabled);

            // Show/hide manual control based on automatic mode
            const manualControl = document.getElementById('manualControl');
            const autoModeCard = document.querySelector('.auto-mode');
            
            if (enabled) {
                manualControl.style.display = 'none';
                autoModeCard.classList.add('active');
                // If automatic mode is enabled, ensure pump is off
                const pumpRef = ref(database, 'pump');
                update(pumpRef, {
                    status: false,
                    lastRun: null
                });
                const controlPumpRef = ref(database, 'control/pump');
                set(controlPumpRef, 0);
            } else {
                manualControl.style.display = 'block';
                autoModeCard.classList.remove('active');
            }
        }

        // Function to update last run time
        function updateLastRunTime(timestamp) {
            if (timestamp) {
                const date = new Date(timestamp);
                lastRunTime.textContent = date.toLocaleTimeString();
            } else {
                lastRunTime.textContent = '--:--';
            }
        }

        // Function to update water level
        function updateWaterLevel(level) {
            waterLevel.textContent = `${level}%`;
            const waterLevelIcon = document.getElementById('waterLevelIcon');
            if (level < 20) {
                waterLevelIcon.style.color = '#e74c3c';
            } else if (level < 50) {
                waterLevelIcon.style.color = '#f1c40f';
            } else {
                waterLevelIcon.style.color = '#2ecc71';
            }
        }

        // Listen for real-time updates
        const pumpRef = ref(database, 'pump');
        onValue(pumpRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                // Only update visual status, actual control done by schedule/manual
                pumpStatus.textContent = data.status ? 'Running' : 'Stopped';
                pumpStatusIcon.style.color = data.status ? '#2ecc71' : '#e74c3c';
                pumpToggle.checked = data.status;
                updateLastRunTime(data.lastRun);
            }
        });

        // Listen for water level updates
        const waterRef = ref(database, 'sensor/water');
        onValue(waterRef, (snapshot) => {
            const waterLevel = snapshot.val();
            if (waterLevel !== null) {
                updateWaterLevel(waterLevel);
            }
        });

        // Listen for automatic mode changes
        const autoModeRef = ref(database, 'control/automatic');
        onValue(autoModeRef, (snapshot) => {
            const autoMode = snapshot.val();
            updateAutoMode(autoMode);
        });

        // Manual pump control
        pumpToggle.addEventListener('change', () => {
            updatePumpStatus(pumpToggle.checked, 'manual');
        });

        startPumpBtn.addEventListener('click', () => {
            const duration = parseInt(pumpDuration.value);
            if (duration > 0) {
                updatePumpStatus(true, 'manual');
                setTimeout(() => {
                    updatePumpStatus(false, 'manual');
                }, duration * 60 * 1000);
            }
        });

        // Automatic mode control
        autoModeToggle.addEventListener('change', () => {
            updateAutoMode(autoModeToggle.checked);
            if (autoModeToggle.checked) {
                updatePumpStatus(false, 'automatic');
            }
        });

        // Schedule pump control
        function startScheduledPump(duration) {
            updatePumpStatus(true, 'scheduled');
            setTimeout(() => {
                updatePumpStatus(false, 'scheduled');
            }, duration * 60 * 1000);
        }

        // Function to render pump history
        function renderPumpHistory(history) {
            historyList.innerHTML = '';
            if (!history || Object.keys(history).length === 0) {
                historyList.innerHTML = '<p class="text-gray-500 text-center py-4">No pump activity recorded</p>';
                return;
            }

            // Create table
            const table = document.createElement('table');
            table.className = 'min-w-full divide-y divide-gray-200';
            
            // Create table header
            const thead = document.createElement('thead');
            thead.className = 'bg-gray-50';
            thead.innerHTML = `
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Start Time</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">End Time</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trigger Type</th>
                </tr>
            `;
            table.appendChild(thead);

            // Create table body
            const tbody = document.createElement('tbody');
            tbody.className = 'bg-white divide-y divide-gray-200';

            // Sort history by start time (newest first)
            const sortedHistory = Object.entries(history)
                .sort(([, a], [, b]) => b.startTime - a.startTime);

            sortedHistory.forEach(([key, entry], index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';

                // Format trigger type with appropriate styling
                let triggerTypeClass = 'px-2 py-1 rounded-full text-xs font-medium ';
                let triggerTypeText = entry.triggerType || 'manual';
                
                switch(triggerTypeText.toLowerCase()) {
                    case 'manual':
                        triggerTypeClass += 'bg-blue-100 text-blue-800';
                        break;
                    case 'scheduled':
                        triggerTypeClass += 'bg-purple-100 text-purple-800';
                        break;
                    case 'automatic':
                        triggerTypeClass += 'bg-green-100 text-green-800';
                        break;
                    default:
                        triggerTypeClass += 'bg-gray-100 text-gray-800';
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${new Date(entry.startTime).toLocaleString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${new Date(entry.endTime).toLocaleString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${entry.duration} minutes
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="${triggerTypeClass}">${triggerTypeText}</span>
                    </td>
                `;
                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            historyList.appendChild(table);
        }

        // Listen for pump history updates
        const pumpHistoryRef = ref(database, 'pumpHistory');
        onValue(pumpHistoryRef, (snapshot) => {
            const data = snapshot.val();
            renderPumpHistory(data);
        });

        // Function to render irrigation schedule
        function renderIrrigationSchedule(scheduleData) {
            scheduleList.innerHTML = '';
            if (scheduleData) {
                const sortedSchedule = Object.entries(scheduleData).sort(([, a], [, b]) => a.scheduleTime.localeCompare(b.scheduleTime));
                sortedSchedule.forEach(([key, entry]) => {
                    const scheduleItem = document.createElement('div');
                    scheduleItem.className = 'bg-white p-4 rounded-lg shadow-md mb-3 border border-gray-200 flex items-center justify-between';
                    scheduleItem.innerHTML = `
                        <div>
                            <span class="font-bold text-lg text-gray-800 flex items-center">
                                <i class="fas fa-clock mr-2 text-indigo-500"></i> Scheduled for ${entry.scheduleTime}
                            </span>
                            <p class="text-sm text-gray-700 flex items-center mt-1">
                                <i class="fas fa-hourglass-start mr-2 text-purple-500"></i> Duration: <span class="font-semibold">${entry.duration} min</span>
                            </p>
                        </div>
                        <button class="btn btn-danger text-sm px-3 py-1" data-schedule-key="${key}">
                            <i class="fas fa-trash-alt"></i> Delete
                        </button>
                    `;
                    scheduleList.appendChild(scheduleItem);
        });

                // Add event listeners for delete buttons
                document.querySelectorAll('[data-schedule-key]').forEach(button => {
                    button.addEventListener('click', async (event) => {
                        const scheduleKey = event.target.dataset.scheduleKey;
                        if (confirm('Are you sure you want to delete this schedule?')) {
                            try {
                                await remove(child(ref(database, 'irrigationSchedule'), scheduleKey));
                                alert('Schedule deleted successfully!');
                            } catch (error) {
                                alert(`Failed to delete schedule: ${error.message}`);
                            }
                        }
                    });
                });
            } else {
                scheduleList.innerHTML = '<p class="text-gray-600 text-center py-4">No irrigation schedules set.</p>';
            }
        }

        // Event listener for adding schedule
        addScheduleBtn.addEventListener('click', async () => {
            const scheduleTime = scheduleTimeInput.value;
            const duration = scheduleDurationInput.value;

            if (!scheduleTime || !duration || duration <= 0) {
                alert('Please enter a valid time and a positive duration for the schedule.');
                return;
            }

            try {
                const irrigationScheduleRef = ref(database, 'irrigationSchedule');
                const newScheduleEntryRef = push(irrigationScheduleRef);
                await set(newScheduleEntryRef, {
                    scheduleTime: scheduleTime,
                    duration: parseFloat(duration),
                    createdAt: new Date().getTime(),
                    status: 'active' // Set initial status to active
                });
                alert('Irrigation schedule added successfully!');
                // Clear inputs
                scheduleTimeInput.value = '';
                scheduleDurationInput.value = '';
            } catch (error) {
                alert(`Failed to add schedule: ${error.message}`);
                }
        });

        // Firebase reference for irrigation schedules
        const irrigationScheduleRef = ref(database, 'irrigationSchedule');

        // Function to check and trigger schedules
        async function checkSchedules() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMinute = now.getMinutes();
            const currentDay = now.getDate();

            try {
                const snapshot = await get(irrigationScheduleRef);
                if (snapshot.exists()) {
                    const schedules = snapshot.val();
                    for (const key in schedules) {
                        const schedule = schedules[key];
                        if (schedule.status === 'active') {
                            const [scheduleHour, scheduleMinute] = schedule.scheduleTime.split(':').map(Number);

                            // Check if current time matches scheduled time
                            if (currentHour === scheduleHour && currentMinute === scheduleMinute) {
                                // Prevent re-triggering for the same minute
                                if (schedule.lastTriggeredDay !== currentDay) { // Check if already triggered today
                                    console.log(`Triggering pump for schedule at ${schedule.scheduleTime} for ${schedule.duration} minutes.`);
                                    // Trigger pump ON
                                    updatePumpStatus(true);

                                    // Update schedule status in Firebase to 'triggered' and record last triggered day
                                    await update(child(irrigationScheduleRef, key), {
                                        status: 'triggered',
                                        lastTriggeredDay: currentDay
                                    });

                                    // Schedule pump OFF after duration
                                    if (currentPumpTimeout) clearTimeout(currentPumpTimeout);
                                    currentPumpTimeout = setTimeout(async () => {
                                        console.log(`Stopping pump for schedule at ${schedule.scheduleTime}.`);
                                        updatePumpStatus(false);
                                        await update(child(irrigationScheduleRef, key), { status: 'completed' }); // Optional: mark as completed
                                        currentPumpTimeout = null;
                                    }, schedule.duration * 60 * 1000); // Duration in milliseconds
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.error("Error checking schedules:", error);
            }
        }

        // Listen for irrigation schedule updates and re-render
        onValue(irrigationScheduleRef, (snapshot) => {
            const data = snapshot.val();
            renderIrrigationSchedule(data);
            checkSchedules(); // Also check schedules when data changes
        });

        // Periodically check schedules every minute
        setInterval(checkSchedules, 60 * 1000);

        // Enable history section elements (remove future work labels if still present)
        const historySectionH2Span = document.querySelector('.history-section h2 span');
        if (historySectionH2Span) historySectionH2Span.remove();
        document.getElementById('historyFilter').disabled = false;

        // Enable schedule section elements (remove future work labels if still present)
        const scheduleSectionH2Span = document.querySelector('.schedule-section h2 span');
        if (scheduleSectionH2Span) scheduleSectionH2Span.remove();
        // The addSchedule button is already enabled by default in the HTML as we are removing the disabled attribute.

        const futureWorkMessageSchedule = document.querySelector('#scheduleList .future-work-message');
        if (futureWorkMessageSchedule) futureWorkMessageSchedule.remove();
        const futureWorkMessageHistory = document.querySelector('#historyList .future-work-message');
        if (futureWorkMessageHistory) futureWorkMessageHistory.remove();

        // Filter functionality (basic, can be expanded)
        historyFilter.addEventListener('change', (event) => {
            // Implement filtering logic here if needed based on the selected value
            // For now, it will just re-render all history. More complex filtering 
            // would involve querying Firebase with orderByChild and startAt/endAt
            onValue(pumpHistoryRef, (snapshot) => {
                const data = snapshot.val();
                renderPumpHistory(data);
            });
        });
    </script>
</body>
</html>
