<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartFarm - Agriculture Chatbot</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Common JavaScript -->
    <script src="common.js"></script>
    <style>
        .chat-container {
            height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .message {
            max-width: 80%;
            margin: 10px;
            padding: 10px 15px;
            border-radius: 15px;
            position: relative;
        }
        .user-message {
            background-color: #e3f2fd;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        .bot-message {
            background-color: #f5f5f5;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        .typing-indicator {
            display: none;
            padding: 10px;
            margin: 10px;
        }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #666;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: typing 1s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                <div class="logo">
                    <i class="fas fa-leaf"></i>
                    <span>SmartFarm</span>
                </div>
            </a>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="dashboard.html">Dashboard</a>
                <a href="pump.html">Pump</a>
                <div class="dropdown">
                    <a href="#" class="dropdown-trigger">Predict</a>
                    <div class="dropdown-content">
                        <a href="crop-prediction.html">Crop</a>
                        <a href="fertilizer-prediction.html">Fertilizer</a>
                        <a href="yield-prediction.html">Yield</a>
                    </div>
                </div>
                <a href="disease-detection.html">Disease</a>
                <a href="chatbot.html" class="active">Chat</a>
                <a href="about.html">About</a>
            </div>
            <div class="auth-controls">
                <span id="greeting">Hello, Ziad</span>
                <button id="logoutBtn" class="btn-logout">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-800 mb-8 flex items-center">
                <i class="fas fa-robot text-green-500 mr-3"></i>
                Agriculture Expert Chatbot
            </h1>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="chat-container mb-4" id="chatContainer">
                    <div class="message bot-message">
                        Hello! I'm your agriculture expert assistant. Ask me anything about farming, crops, soil, or sustainable agriculture practices. I can respond in both English and Arabic.
                    </div>
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>

                <form id="chatForm" class="flex gap-2">
                    <input type="text" id="userInput" 
                           class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                           placeholder="Type your question here...">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Send
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.1/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDL2h9dxXjU-2a6lEwK-iR2AL76FHLGc88",
            authDomain: "smartfarm-50e9f.firebaseapp.com",
            databaseURL: "https://smartfarm-50e9f-default-rtdb.firebaseio.com",
            projectId: "smartfarm-50e9f",
            storageBucket: "smartfarm-50e9f.firebasestorage.app",
            messagingSenderId: "615423373084",
            appId: "1:615423373084:web:e4af0444a7db2f9fa754d9",
            measurementId: "G-8TDXE1451F"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Check authentication
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
            }
        });

        // Chat history
        let chatHistory = [];

        // System prompt
        const baseSystemPrompt = `
            You are an expert in agriculture, specializing in crop management, soil health, pest control, and sustainable farming practices.

            Rules:
            1. You ONLY answer questions related to agriculture.
            2. If the question is NOT related to agriculture, reply exactly: "I do not know".
            3. If the user asks in Arabic, you must respond in Arabic.
            4. If the user asks for an "explanation" or says "اشرح", provide a detailed response.
            5. Otherwise, give a short, direct answer.
            6. You must remember the previous conversation to maintain context.
            7. Never answer questions outside agriculture. Never make up answers for non-agriculture topics.
        `;

        // Arabic detection
        function isArabic(text) {
            return /[\u0600-\u06FF]/.test(text);
        }

        // Create full prompt with memory
        function createFullPromptWithMemory(userInput) {
            let prompt = baseSystemPrompt + "\n\n";
            
            for (const [role, message] of chatHistory) {
                if (role === "user") {
                    prompt += `[User]: ${message}\n`;
                } else if (role === "bot") {
                    prompt += `[Bot]: ${message}\n`;
                }
            }
            
            prompt += `[User]: ${userInput}\n`;

            if (userInput.toLowerCase().includes("explain") || userInput.includes("اشرح")) {
                prompt += "Instruction: Please provide a detailed explanation.\n";
            } else {
                prompt += "Instruction: Please provide a short and direct answer.\n";
            }

            return prompt;
        }

        // Chat form submission
        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userInput = document.getElementById('userInput');
            const message = userInput.value.trim();
            
            if (!message) return;

            // Add user message to chat
            addMessageToChat('user', message);
            userInput.value = '';

            // Show typing indicator
            document.getElementById('typingIndicator').style.display = 'block';

            try {
                const response = await fetch('https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key=AIzaSyCwWUf8HN6IUOjr1v0yzGJQ6hPsL3U3tLY', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: createFullPromptWithMemory(message)
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 1024,
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    throw new Error(errorData.error?.message || 'API request failed');
                }

                const data = await response.json();
                console.log('API Response:', data);

                if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) {
                    throw new Error('Invalid response format from API');
                }

                const botResponse = data.candidates[0].content.parts[0].text;

                // Update chat history
                chatHistory.push(['user', message]);
                chatHistory.push(['bot', botResponse]);

                // Add bot response to chat
                addMessageToChat('bot', botResponse);
            } catch (error) {
                console.error('Error:', error);
                addMessageToChat('bot', `Sorry, I encountered an error: ${error.message}. Please try again.`);
            } finally {
                // Hide typing indicator
                document.getElementById('typingIndicator').style.display = 'none';
            }
        });

        // Add message to chat
        function addMessageToChat(role, message) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}-message`;
            messageDiv.textContent = message;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    </script>
</body>
</html> 